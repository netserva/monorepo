name: Split Monorepo

on:
  push:
    tags:
      - '*-v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to split (e.g., core-v3.0.1)'
        required: true

jobs:
  split:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        package:
          # 8 active packages (7 functional + platform bundle)
          # Removed: admin (→core), cli (→core), cron (→ops), ipam (→fleet), wg (→fleet), config (unused)
          - { name: 'cms', path: 'packages/netserva-cms', repo: 'netserva/cms' }
          - { name: 'core', path: 'packages/netserva-core', repo: 'netserva/core' }
          - { name: 'dns', path: 'packages/netserva-dns', repo: 'netserva/dns' }
          - { name: 'fleet', path: 'packages/netserva-fleet', repo: 'netserva/fleet' }
          - { name: 'mail', path: 'packages/netserva-mail', repo: 'netserva/mail' }
          - { name: 'ops', path: 'packages/netserva-ops', repo: 'netserva/ops' }
          - { name: 'platform', path: 'packages/netserva-platform', repo: 'netserva/platform' }
          - { name: 'web', path: 'packages/netserva-web', repo: 'netserva/web' }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check if tag matches this package
        id: check_tag
        run: |
          # Handle both push (tag) and workflow_dispatch triggers
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi

          PACKAGE_PREFIX="${{ matrix.package.name }}-v"

          echo "Tag: $TAG_NAME"
          echo "Looking for prefix: $PACKAGE_PREFIX"

          if [[ $TAG_NAME == $PACKAGE_PREFIX* ]]; then
            echo "match=true" >> $GITHUB_OUTPUT
            # Strip package prefix to get clean version tag
            VERSION_TAG="${TAG_NAME#$PACKAGE_PREFIX}"
            echo "version=v$VERSION_TAG" >> $GITHUB_OUTPUT
            echo "Match found! Clean version: v$VERSION_TAG"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "No match, skipping this package"
          fi

      - name: Install splitsh-lite
        if: steps.check_tag.outputs.match == 'true'
        run: |
          wget https://github.com/splitsh/lite/releases/download/v1.0.1/lite_linux_amd64.tar.gz
          tar -zxf lite_linux_amd64.tar.gz
          chmod +x splitsh-lite
          sudo mv splitsh-lite /usr/local/bin/

      - name: Split and push package
        if: steps.check_tag.outputs.match == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "markc"
          git config --global user.email "markc@renta.net"

          # Clear default GitHub auth and configure our token
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Split the package
          SHA=$(splitsh-lite --prefix=${{ matrix.package.path }}/)

          # Push to split repository using token
          git push https://github.com/${{ matrix.package.repo }}.git $SHA:refs/heads/main --force
          git push https://github.com/${{ matrix.package.repo }}.git $SHA:refs/tags/${{ steps.check_tag.outputs.version }} --force

      - name: Split complete
        if: steps.check_tag.outputs.match == 'true'
        run: |
          echo "✅ Package ${{ matrix.package.name }} successfully split to ${{ matrix.package.repo }}"
          echo "✅ Tagged as ${{ steps.check_tag.outputs.version }}"
