#!/bin/bash
#
# Renew Let's Encrypt wildcard certificate for *.goldcoast.org
# and deploy to all PVE/PBS hosts
#
# Usage: renew-goldcoast-cert [--force]
#
# Requires:
#   - SSH access to ns1gc (for PowerDNS API tunnel)
#   - SSH access to pbs2,pbs3,pbs4,pve2,pve3,pve4
#   - acme.sh installed at /usr/sbin/acme.sh
#
# Author: NetServa 3.0
# Date: 2025-12-05

set -euo pipefail

# Configuration
DOMAIN="goldcoast.org"
WILDCARD="*.${DOMAIN}"
EMAIL="admin@${DOMAIN}"
ACME_HOME="${HOME}/.acme.sh"
CERT_DIR="${ACME_HOME}/${WILDCARD}_ecc"
TUNNEL_PORT=18081
TUNNEL_HOST="ns1gc"

# PowerDNS configuration
PDNS_URL="http://localhost:${TUNNEL_PORT}"
PDNS_SERVER_ID="localhost"
PDNS_TOKEN="pdns_api_ns1gc_d5eeaf3798da9ba265c6415720de444c"
PDNS_TTL=60

# Target hosts
PBS_HOSTS="pbs2 pbs3 pbs4"
PVE_HOSTS="pve2 pve3 pve4"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

cleanup() {
    log_info "Cleaning up SSH tunnel..."
    pkill -f "ssh.*-L ${TUNNEL_PORT}:localhost:8081.*${TUNNEL_HOST}" 2>/dev/null || true
}

trap cleanup EXIT

check_tunnel() {
    if curl -s -H "X-API-Key: ${PDNS_TOKEN}" "${PDNS_URL}/api/v1/servers/localhost/zones" >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

setup_tunnel() {
    log_info "Setting up SSH tunnel to ${TUNNEL_HOST}..."

    # Kill any existing tunnel
    pkill -f "ssh.*-L ${TUNNEL_PORT}:localhost:8081.*${TUNNEL_HOST}" 2>/dev/null || true
    sleep 1

    # Create new tunnel
    ssh -f -N -L ${TUNNEL_PORT}:localhost:8081 ${TUNNEL_HOST}
    sleep 2

    # Verify tunnel
    if ! check_tunnel; then
        log_error "Failed to establish tunnel to PowerDNS API"
        exit 1
    fi

    log_info "Tunnel established successfully"
}

renew_certificate() {
    local force_flag=""
    if [[ "${1:-}" == "--force" ]]; then
        force_flag="--force"
        log_info "Force renewal requested"
    fi

    log_info "Renewing certificate for ${WILDCARD} and ${DOMAIN}..."

    export PDNS_Url="${PDNS_URL}"
    export PDNS_ServerId="${PDNS_SERVER_ID}"
    export PDNS_Token="${PDNS_TOKEN}"
    export PDNS_Ttl="${PDNS_TTL}"

    /usr/sbin/acme.sh --renew -d "${WILDCARD}" -d "${DOMAIN}" \
        --dns dns_pdns \
        --server letsencrypt \
        ${force_flag} 2>&1 | grep -v "integer expected" || true

    # Check if certificate exists and is valid
    if [[ ! -f "${CERT_DIR}/fullchain.cer" ]]; then
        log_error "Certificate file not found at ${CERT_DIR}/fullchain.cer"
        exit 1
    fi

    # Verify certificate
    local expiry
    expiry=$(openssl x509 -in "${CERT_DIR}/fullchain.cer" -noout -enddate 2>/dev/null | cut -d= -f2)
    log_info "Certificate valid until: ${expiry}"
}

deploy_to_pbs() {
    log_info "Deploying certificate to PBS hosts..."

    for host in ${PBS_HOSTS}; do
        log_info "  -> ${host}"

        # Copy cert and key
        scp -q "${CERT_DIR}/fullchain.cer" "${host}:/etc/proxmox-backup/proxy.pem"
        scp -q "${CERT_DIR}/${WILDCARD}.key" "${host}:/etc/proxmox-backup/proxy.key"

        # Set permissions and reload
        ssh "${host}" 'chmod 640 /etc/proxmox-backup/proxy.pem /etc/proxmox-backup/proxy.key && \
                       chown root:backup /etc/proxmox-backup/proxy.pem /etc/proxmox-backup/proxy.key && \
                       systemctl reload proxmox-backup-proxy' && \
            log_info "     ${host}: OK" || \
            log_error "    ${host}: FAILED"
    done
}

deploy_to_pve() {
    log_info "Deploying certificate to PVE hosts..."

    for host in ${PVE_HOSTS}; do
        log_info "  -> ${host}"

        # Copy cert and key
        scp -q "${CERT_DIR}/fullchain.cer" "${host}:/etc/pve/local/pveproxy-ssl.pem"
        scp -q "${CERT_DIR}/${WILDCARD}.key" "${host}:/etc/pve/local/pveproxy-ssl.key"

        # Reload proxy
        ssh "${host}" 'systemctl reload pveproxy' && \
            log_info "     ${host}: OK" || \
            log_error "    ${host}: FAILED"
    done
}

verify_certificates() {
    log_info "Verifying certificates on all hosts..."

    local failed=0

    for host in ${PBS_HOSTS}; do
        local subject
        subject=$(echo | timeout 5 openssl s_client -connect "${host}.${DOMAIN}:8007" 2>/dev/null | \
                  openssl x509 -noout -subject 2>/dev/null | grep -o "CN=.*" || echo "FAILED")
        if [[ "${subject}" == "CN=${WILDCARD}" ]]; then
            log_info "  ${host}: ${subject}"
        else
            log_error "  ${host}: ${subject}"
            ((failed++))
        fi
    done

    for host in ${PVE_HOSTS}; do
        local subject
        subject=$(echo | timeout 5 openssl s_client -connect "${host}.${DOMAIN}:8006" 2>/dev/null | \
                  openssl x509 -noout -subject 2>/dev/null | grep -o "CN=.*" || echo "FAILED")
        if [[ "${subject}" == "CN=${WILDCARD}" ]]; then
            log_info "  ${host}: ${subject}"
        else
            log_error "  ${host}: ${subject}"
            ((failed++))
        fi
    done

    if [[ ${failed} -gt 0 ]]; then
        log_error "${failed} host(s) failed verification"
        return 1
    fi

    log_info "All hosts verified successfully"
}

main() {
    echo "=================================================="
    echo "  Let's Encrypt Certificate Renewal"
    echo "  Domain: ${WILDCARD}, ${DOMAIN}"
    echo "=================================================="
    echo

    setup_tunnel
    renew_certificate "${1:-}"
    deploy_to_pbs
    deploy_to_pve
    verify_certificates

    echo
    log_info "Certificate renewal and deployment complete!"
}

main "$@"
