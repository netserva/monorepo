# NetServa Dovecot 2.4.1 Configuration Template - GOLD STANDARD
#
# This configuration has been extensively tested and optimized for:
# - Maildir format as default (no sdbox/mdbox autodetection overhead)
# - Full Sieve support with all extensions and debugging
# - Embedded MySQL authentication queries
# - Postfix integration via LMTP and SASL
# - SSL/TLS security with modern ciphers
# - Performance optimizations for production use
#
# Installation Instructions:
# 1. Copy to /etc/dovecot/dovecot.conf on target server
# 2. Replace placeholders with actual values:
#    sed -i 's/_DOMAIN/yourdomain.com/g' /etc/dovecot/dovecot.conf
#    sed -i 's/_MAIL_DOMAIN/mail.yourdomain.com/g' /etc/dovecot/dovecot.conf
#    sed -i 's/_DB_NAME/your_db_name/g' /etc/dovecot/dovecot.conf
#    sed -i 's/_DB_USER/your_db_user/g' /etc/dovecot/dovecot.conf
#    sed -i 's/_DB_PASSWORD/your_db_password/g' /etc/dovecot/dovecot.conf
# 3. Ensure SSL certificates exist at specified paths
# 4. Restart dovecot: systemctl restart dovecot
#
# Created: 20250924 from working pbe.net.au configuration
# NetServa Infrastructure Stack (NS) - Dovecot 2.4.1 Template

# Dovecot 2.4.1 Configuration - Single File
dovecot_config_version = 2.4.1
dovecot_storage_version = 2.4.1

# Mail configuration - NEW 2.4.1 syntax
mail_driver = maildir
mail_path = ~/Maildir
mail_home = ~
mail_uid = 1000
mail_gid = 1000

# SSL Configuration
ssl = required
ssl_min_protocol = TLSv1.2
ssl_cipher_list = HIGH:!aNULL:!MD5
ssl_server_cert_file = /etc/ssl/mail._DOMAIN/mail._DOMAIN.crt
ssl_server_key_file = /etc/ssl/mail._DOMAIN/mail._DOMAIN.key
ssl_server_ca_file = /etc/ssl/certs/ca-certificates.crt

# Debug settings
auth_debug = yes
auth_verbose = yes
mail_debug = yes

# Basic settings
auth_mechanisms = plain login
auth_master_user_separator = *
default_vsz_limit = 512M
listen = *, [::]
protocols = imap lmtp sieve
sql_driver = mysql

# Performance settings
mail_fsync = never
maildir_very_dirty_syncs = yes
mailbox_list_index = yes
lmtp_save_to_detail_mailbox = yes

# Database connection
mysql localhost {
  dbname = _DB_NAME
  password = _DB_PASSWORD
  user = _DB_USER
}

# Namespace configuration
namespace inbox {
  inbox = yes
  prefix =
  separator = /

  mailbox Sent {
    auto = subscribe
    special_use = \\Sent
  }
  mailbox Junk {
    auto = subscribe
    special_use = \\Junk
    autoexpunge = 7d
  }
  mailbox Archive {
    auto = subscribe
    special_use = \\Archive
  }
  mailbox Drafts {
    auto = subscribe
    special_use = \\Drafts
  }
  mailbox Trash {
    auto = subscribe
    special_use = \\Trash
  }
}

# Services
service auth {
  unix_listener /var/spool/postfix/private/auth {
    group = postfix
    mode = 0660
    user = postfix
  }
  unix_listener auth-userdb {
    group = dovecot
    mode = 0600
    user = dovecot
  }
}

service auth-worker {
  user = dovecot
}

service imap-login {
  process_min_avail = 4
  restart_request_count = 1
  vsz_limit = 1G

  inet_listener imap {
    port = 0
  }
  inet_listener imaps {
    port = 993
  }
}

service lmtp {
  executable = lmtp -L
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    group = postfix
    mode = 0660
    user = postfix
  }
}

service managesieve-login {
  inet_listener sieve {
    port = 4190
  }
}

service managesieve {
  process_limit = 256
}

# Protocol configurations
protocol imap {
  mail_plugins = imap_sieve
}

protocol lmtp {
  mail_plugins = sieve
}

# Authentication - WITH EMBEDDED SQL QUERIES
passdb master_auth {
  driver = sql
  master = yes
  result_success = continue
  sql_query = SELECT password FROM master_users WHERE user = '%{auth_user}' AND active = 1
}

passdb regular_auth {
  driver = sql
  sql_query = SELECT password FROM mailboxes WHERE user = '%{user}' AND active = 1
}

userdb vmails_userdb {
  driver = sql
  sql_iterate_query = SELECT user FROM mailboxes WHERE active = 1
  sql_query = SELECT home, uid, gid FROM mailboxes WHERE user = "%{user}" AND active = 1
}

# SIEVE CONFIGURATION (Dovecot 2.4.1 working syntax)
sieve_execute_bin_dir = /etc/dovecot/sieve
sieve_pipe_bin_dir = /etc/dovecot/sieve
sieve_max_redirects = 30
sieve_max_script_size = 1M
sieve_redirect_envelope_from = recipient
sieve_plugins = sieve_imapsieve sieve_extprograms

# Sieve extensions configuration
sieve_extensions {
  fileinto = yes
  reject = yes
  envelope = yes
  encoded-character = yes
  vacation = yes
  subaddress = yes
  comparator-i;ascii-numeric = yes
  relational = yes
  regex = yes
  imap4flags = yes
  copy = yes
  include = yes
  body = yes
  variables = yes
  enotify = yes
  environment = yes
  mailbox = yes
  date = yes
  index = yes
  ihave = yes
  duplicate = yes
  mime = yes
  foreverypart = yes
  extracttext = yes
  vacation-seconds = yes
  vnd.dovecot.pipe = yes
  vnd.dovecot.debug = yes
  vnd.dovecot.execute = yes
}

# Protocol sieve configuration
protocol sieve {
  mail_max_userip_connections = 10
  managesieve_implementation_string = Dovecot Pigeonhole
  managesieve_logout_format = bytes=%i/%o
  managesieve_max_compile_errors = 5
  managesieve_max_line_length = 65536
}

# Personal sieve scripts configuration
sieve_script personal {
  driver = file
  path = ~/sieve
  active_path = ~/.dovecot.sieve
  type = personal
}

# Global after script
sieve_script global_after {
  type = after
  driver = file
  path = /etc/dovecot/sieve/global.sieve
}

# Sieve debugging
log_debug = category=sieve
sieve_trace_dir = ~/sieve-trace/
sieve_trace_level = actions
sieve_trace_debug = yes