# Created: 20250805 - Updated: 20250805
# Copyright (C) 1995-2025 Mark Constable <mc@netserva.org> (MIT License)
#
# Dovecot 2.4.1 Lean Configuration Template
# Single file approach - no conf.d/ directory needed
#
# Usage: Replace placeholders with actual values:
#   sed -i 's/_MAILHOST_/mail.example.com/g' dovecot.conf
#   sed -i 's/_DB_PASSWORD_/your_password/g' dovecot.conf
#
# 2.4.1-4 (7d8c0e5759): /etc/dovecot/dovecot.conf
# Pigeonhole version 2.4.1-4 (0a86619f)
# OS: Linux x86_64 Debian/Ubuntu
# Hostname: _HOSTNAME_

dovecot_config_version = 2.4.1
dovecot_storage_version = 2.4.0

# SSL Configuration for Dovecot 2.4.1
ssl = required
ssl_min_protocol = TLSv1.2
ssl_cipher_list = HIGH:!aNULL:!MD5

ssl_server_cert_file = /root/.acme.sh/_MAILHOST__ecc/fullchain.cer
ssl_server_key_file = /root/.acme.sh/_MAILHOST__ecc/_MAILHOST_.key
ssl_server_ca_file = /etc/ssl/certs/ca-certificates.crt

# Logging Configuration
log_path = /var/log/dovecot.log
info_log_path = /var/log/dovecot-info.log  
debug_log_path = /var/log/dovecot-debug.log
auth_debug = yes
auth_verbose = yes
mail_debug = yes
#auth_debug_passwords = yes

# Authentication and Protocol Settings
auth_master_user_separator = *
auth_mechanisms = plain login
default_vsz_limit = 512 M
listen = *
lmtp_save_to_detail_mailbox = yes
mail_fsync = never
mailbox_list_index = yes
maildir_very_dirty_syncs = yes
mail_log_events = delete undelete expunge copy mailbox_delete mailbox_rename
mail_log_fields = uid box msgid size
mail_plugin_dir = /usr/lib/dovecot/modules/
managesieve_notify_capability = mailto
managesieve_sieve_capability = fileinto reject envelope encoded-character vacation subaddress comparator-i;ascii-numeric relational regex imap4flags copy include variables body enotify environment mailbox date index ihave duplicate mime foreverypart extracttext vnd.dovecot.debug vnd.dovecot.execute vnd.dovecot.pipe editheader
protocols = imap lmtp sieve

# SIEVE CONFIGURATION (Dovecot 2.4.1 syntax - lean approach)
sieve_execute_bin_dir = /etc/dovecot/sieve
sieve_plugins = sieve_imapsieve sieve_extprograms
sieve_pipe_bin_dir = /usr/bin
sieve_pipe_socket_dir = /etc/dovecot/sieve/sieve-pipe
sieve_max_redirects = 30
sieve_max_script_size = 1M
sieve_redirect_envelope_from = recipient

# Sieve extensions configuration
sieve_extensions {
  fileinto = yes
  reject = yes
  envelope = yes
  encoded-character = yes
  vacation = yes
  subaddress = yes
  comparator-i;ascii-numeric = yes
  relational = yes
  regex = yes
  imap4flags = yes
  copy = yes
  include = yes
  body = yes
  variables = yes
  enotify = yes
  environment = yes
  mailbox = yes
  date = yes
  index = yes
  ihave = yes
  duplicate = yes
  mime = yes
  foreverypart = yes
  extracttext = yes
  vacation-seconds = yes
  string = no
  vnd.dovecot.pipe = yes
  vnd.dovecot.debug = yes
  vnd.dovecot.execute = yes
}

sieve_global_extensions {
  vnd.dovecot.debug = yes
  editheader = yes
  vnd.dovecot.pipe = yes
  vnd.dovecot.execute = yes
}

# Database driver configuration
sql_driver = mysql
sqlite_path = /srv/_VHOST_/var/www/dovecot/database.sqlite

# Maildir configuration
maildir {
  very_dirty_syncs = yes
}

# Namespace configuration with IMAPSieve spam training
namespace inbox {
  inbox = yes
  prefix = 
  separator = /
  
  mailbox Sent {
    auto = subscribe
    special_use = \"\\\\Sent\"
  }
  
  mailbox \"Junk-Ham\" {
    auto = subscribe
    special_use = \"\\\\Junk\"
    sieve_script retrain_ham {
      cause = copy move append
      path = /etc/dovecot/sieve/retrain-as-ham.sieve
      type = before
    }
  }
  
  mailbox Junk {
    auto = subscribe
    special_use = \"\\\\Junk\"
    sieve_script retrain_spam {
      cause = copy move append
      path = /etc/dovecot/sieve/retrain-as-spam.sieve
      type = before
    }
    sieve_script retrain_ham {
      cause = delete move
      path = /etc/dovecot/sieve/retrain-as-good.sieve
      type = after
    }
  }
  
  mailbox Archive {
    auto = subscribe
    special_use = \"\\\\Archive\"  
  }
  
  mailbox Drafts {
    auto = subscribe
    special_use = \"\\\\Drafts\"
  }
  
  mailbox Trash {
    auto = subscribe
    special_use = \"\\\\Trash\"
  }
}

# Service Configurations

service auth {
  unix_listener /var/spool/postfix/private/auth {
    group = postfix
    mode = 0660
    user = postfix
  }
  unix_listener auth-userdb {
    mode = 0777
  }
}

service dict {
  unix_listener dict {
    mode = 0666
  }
}

service imap-login {
  process_min_avail = 4
  restart_request_count = 1
  vsz_limit = 1 G
  inet_listener imap {
    port = 0
  }
  inet_listener imaps {
    port = 993
  }
}

service lmtp {
  executable = lmtp -L
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    group = postfix
    mode = 0660
    user = postfix
  }
}

service managesieve-login {
  inet_listener sieve {
    port = 4190
  }
}

service managesieve {
  process_limit = 256
}

# Protocol Configurations

protocol sieve {
  info_log_path = /var/log/sieve.log
  log_path = /var/log/sieve.log
  mail_max_userip_connections = 10
  managesieve_implementation_string = Dovecot Pigeonhole
  managesieve_logout_format = bytes=%i/%o
  managesieve_max_compile_errors = 5
  managesieve_max_line_length = 65536
}

# Enable sieve plugin for local delivery (user scripts)
protocol lda {
  mail_plugins = sieve
}

# Enable sieve plugin for LMTP delivery (user scripts)
protocol lmtp {
  mail_plugins = sieve
}

# CRITICAL: Enable imap_sieve plugin for IMAPSieve functionality  
protocol imap {
  imap_idle_notify_interval = 29 mins
  mail_max_userip_connections = 20
  mail_plugins = imap_sieve
}

# IMAPSIEVE CONFIGURATION FOR SPAM TRAINING (Dovecot 2.4.1 global syntax)
# When messages are moved TO Junk folder -> train as spam
# When messages are moved FROM Junk folder to anywhere else -> train as ham
# When messages are moved TO Junk-Ham folder -> train as ham (for false positives)  

# Global after script (runs after user scripts)
sieve_script global_after {
  type = after
  driver = file
  path = /etc/dovecot/sieve/global.sieve
}

# Database configuration
mysql localhost {
  dbname = sysadm
  password = _DB_PASSWORD_
  user = sysadm
}

# Authentication backends
passdb master_auth {
  driver = sql
  master = yes
  result_success = continue
  sql_query = SELECT password FROM master_users WHERE username = '%{auth_user}' AND active = 1
}

passdb regular_auth {
  driver = sql
  sql_query = SELECT password FROM vmails WHERE user = '%{user}'
}

userdb vmails_userdb {
  driver = sql
  sql_iterate_query = SELECT user FROM vmails
  sql_query = SELECT home, uid, gid, CASE WHEN mailbox = 'mdbox' THEN CONCAT('mdbox:', home, '/mdbox') ELSE CONCAT('maildir:', home, '/Maildir') END AS mail FROM vmails WHERE user = '%{user}'
}

# Statistics configuration for monitoring
service stats {
  inet_listener http {
    port = 9900
  }
  process_min_avail = 1
}

# Metrics for performance monitoring
metric lmtp_delivery {
  filter = (event=mail_delivery_finished AND service=lmtp)
}

metric sieve_execution {
  filter = event=sieve_script_finished
}

metric sieve_extprograms {
  filter = (event=sieve_action_finished AND action_name=pipe)
}

metric delivery_errors {
  filter = (event=mail_delivery_finished AND NOT success=yes)
}

metric auth_success {
  filter = (event=auth_request_finished AND success=yes)
}

# Personal sieve scripts configuration (Dovecot 2.4.1)
sieve_script personal {
  driver = file
  path = ~/sieve
  active_path = ~/.dovecot.sieve
  type = personal
}