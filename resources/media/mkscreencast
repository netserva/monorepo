#!/bin/bash
# NetServa Screencast Generator
# Creates terminal screencasts from orchestration files using asciinema
#
# Usage: ./mkscreencast <input.screencast> [output-basename]

set -euo pipefail

# Configuration
PIPER_BIN="/opt/piper-tts/piper"
VOICE_MODEL="/usr/share/piper-voices/en/en_US/hfc_male/medium/en_US-hfc_male-medium.onnx"
TYPING_SPEED="0.05"  # Delay between characters (50ms)

# Parse arguments
INPUT="${1:-}"
OUTPUT="${2:-}"

if [[ -z "$INPUT" ]]; then
    cat << 'HELP'
Usage: mkscreencast <input.screencast> [output-basename]

Terminal screencast generator using asciinema.

Orchestration file format:
  # comment
  > narration (text-to-speech audio)
  $ command (typed and executed)
  wait:N (pause for N seconds)

Example (.screencast file):
  > Welcome to this demonstration
  wait:1
  $ cd /tmp
  $ ls -la
  wait:2
  > That completes the demo

Output:
  - basename.cast (terminal recording)
  - basename-narration.mp3 (TTS audio)

Play both: asciinema play basename.cast & mpv basename-narration.mp3
HELP
    exit 1
fi

if [[ ! -f "$INPUT" ]]; then
    echo "Error: Input file not found: $INPUT"
    exit 1
fi

# Check dependencies
if [[ ! -f "$PIPER_BIN" ]]; then
    echo "Error: Piper TTS not found at $PIPER_BIN"
    exit 1
fi

if ! command -v asciinema >/dev/null 2>&1; then
    echo "Error: asciinema not found"
    echo "Install with: sudo pacman -S asciinema"
    exit 1
fi

if ! command -v ffmpeg >/dev/null 2>&1; then
    echo "Error: ffmpeg not found"
    exit 1
fi

# Set output basename if not provided
if [[ -z "$OUTPUT" ]]; then
    OUTPUT="${INPUT%.screencast}"
fi

CAST_FILE="${OUTPUT}.cast"
NARRATION_TXT="${OUTPUT}-narration.txt"
NARRATION_MP3="${OUTPUT}-narration.mp3"
NARRATION_WAV="/tmp/screencast-narration-$$.wav"
SCRIPT_FILE="/tmp/screencast-$$.sh"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "NetServa Screencast Generator"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Input:      $INPUT"
echo "Terminal:   $CAST_FILE"
echo "Narration:  $NARRATION_MP3"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Cleanup on exit
cleanup() {
    rm -f "$SCRIPT_FILE" "$NARRATION_WAV"
}
trap cleanup EXIT

echo "Step 1: Parsing orchestration file..."

# Generate executable script from orchestration file
cat > "$SCRIPT_FILE" << 'SCRIPT_HEADER'
#!/bin/bash
set -euo pipefail

# Function to simulate typing
type_command() {
    local cmd="$1"
    local delay="$2"

    # Type character by character
    for ((i=0; i<${#cmd}; i++)); do
        echo -n "${cmd:$i:1}"
        sleep "$delay"
    done
    echo ""
}

# Clear screen and show prompt
clear
echo "NetServa Screencast - Recording in progress..."
echo ""

SCRIPT_HEADER

# Extract narration for TTS
> "$NARRATION_TXT"

# Process orchestration file
while IFS= read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" ]] && continue
    [[ "$line" =~ ^#.* ]] && continue

    # Extract narration
    if [[ "$line" =~ ^\>\ (.+) ]]; then
        narration="${BASH_REMATCH[1]}"
        echo "$narration" >> "$NARRATION_TXT"
        echo "" >> "$NARRATION_TXT"
        continue
    fi

    # Execute command with typing simulation
    if [[ "$line" =~ ^\$\ (.+) ]]; then
        cmd="${BASH_REMATCH[1]}"
        echo "echo -n '$ '" >> "$SCRIPT_FILE"
        echo "type_command '$cmd' $TYPING_SPEED" >> "$SCRIPT_FILE"
        echo "$cmd" >> "$SCRIPT_FILE"
        echo "echo ''" >> "$SCRIPT_FILE"
        continue
    fi

    # Wait/pause
    if [[ "$line" =~ ^wait:([0-9.]+) ]]; then
        seconds="${BASH_REMATCH[1]}"
        echo "sleep $seconds" >> "$SCRIPT_FILE"
        continue
    fi
done < "$INPUT"

# Add ending
echo "echo ''" >> "$SCRIPT_FILE"
echo "echo 'Recording complete.'" >> "$SCRIPT_FILE"
echo "sleep 2" >> "$SCRIPT_FILE"

chmod +x "$SCRIPT_FILE"

echo "Step 2: Generating narration audio..."
if [[ -s "$NARRATION_TXT" ]]; then
    "$PIPER_BIN" \
        --model "$VOICE_MODEL" \
        --output_file "$NARRATION_WAV" \
        --length_scale 1.15 \
        --sentence_silence 0.75 \
        --noise_scale 0.5 \
        --noise_w 0.7 \
        < "$NARRATION_TXT" 2>&1 | grep -E "audio=" || true

    # Convert to MP3 with audio processing
    ffmpeg -i "$NARRATION_WAV" \
        -af "acompressor=threshold=0.5:ratio=3:attack=20:release=250:makeup=2,alimiter=limit=0.95:attack=5:release=50,loudnorm=I=-16:TP=-1.5:LRA=11" \
        -ar 48000 \
        -acodec libmp3lame \
        -ab 128k \
        "$NARRATION_MP3" -y 2>&1 | grep -E "(Duration|size=)" || true

    echo "  ✓ Narration audio generated"
else
    echo "  (No narration found)"
fi

echo ""
echo "Step 3: Recording terminal session..."
echo ""
echo "The terminal will now record automatically."
echo "Commands will be typed and executed as scripted."
echo ""
echo "Press ENTER to start recording..."
read -r

# Record with asciinema, executing our generated script
asciinema rec \
    --command "$SCRIPT_FILE" \
    --overwrite \
    "$CAST_FILE"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Screencast generated successfully!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
ls -lh "$CAST_FILE"
[[ -f "$NARRATION_MP3" ]] && ls -lh "$NARRATION_MP3"
echo ""
echo "Play terminal: asciinema play $CAST_FILE"
[[ -f "$NARRATION_MP3" ]] && echo "Play audio:    mpv $NARRATION_MP3"
echo ""
echo "Play both simultaneously:"
echo "  asciinema play $CAST_FILE & mpv $NARRATION_MP3"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
