#!/bin/bash
# Merge screen-recorded asciinema playback with narration audio
#
# Usage: ./cast2video <video.mp4> <narration.mp3> [output.mp4]

set -euo pipefail

VIDEO_FILE="${1:-}"
NARRATION_FILE="${2:-}"
OUTPUT="${3:-}"

if [[ -z "$VIDEO_FILE" ]] || [[ -z "$NARRATION_FILE" ]]; then
    cat << 'HELP'
Usage: cast2video <video.mp4> <narration.mp3> [output.mp4]

Merges screen recording with narration audio.

Workflow:
  1. Record asciinema playback to video:
     - Play: asciinema play demo.cast
     - Record screen with Spectacle (Meta+Shift+R) or OBS
     - Save as demo-recording.mp4

  2. Merge video + narration:
     ./cast2video demo-recording.mp4 demo-narration.mp3 demo-final.mp4

Requirements:
  - ffmpeg

The script will:
  - Replace video audio with narration MP3
  - Match duration to shortest (video or audio)
  - Output final MP4 with synchronized narration
HELP
    exit 1
fi

if [[ ! -f "$VIDEO_FILE" ]]; then
    echo "Error: Video file not found: $VIDEO_FILE"
    exit 1
fi

if [[ ! -f "$NARRATION_FILE" ]]; then
    echo "Error: Narration file not found: $NARRATION_FILE"
    exit 1
fi

# Set output filename
if [[ -z "$OUTPUT" ]]; then
    OUTPUT="${VIDEO_FILE%.mp4}-with-narration.mp4"
fi

# Check ffmpeg
if ! command -v ffmpeg >/dev/null 2>&1; then
    echo "Error: ffmpeg not found"
    exit 1
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Cast to Video - Audio Merger"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Video:     $VIDEO_FILE"
echo "Narration: $NARRATION_FILE"
echo "Output:    $OUTPUT"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Get durations
VIDEO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VIDEO_FILE")
AUDIO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$NARRATION_FILE")

echo "Video duration:     ${VIDEO_DURATION}s"
echo "Narration duration: ${AUDIO_DURATION}s"
echo ""

# Merge video with narration audio
echo "Merging video with narration..."
ffmpeg -i "$VIDEO_FILE" -i "$NARRATION_FILE" \
    -c:v copy \
    -c:a aac \
    -b:a 128k \
    -map 0:v:0 \
    -map 1:a:0 \
    -shortest \
    "$OUTPUT" -y 2>&1 | grep -E "(Duration|frame=|size=)" || true

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Video with narration created successfully!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
ls -lh "$OUTPUT"
echo ""
echo "Play with: mpv $OUTPUT"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
