# NetServa 3.0 Unified Common Config
# Copyright (C) 2015-2025 Mark Constable <mc@netserva.org> (MIT License)
#
# INSTALLATION: Edit /etc/nginx/primary_vhost.conf to set your mail server

# Load PRIMARY_VHOST setting
include                         /etc/nginx/primary_vhost.conf;

# Vhost root and index
root                            /srv/$host/web/app/public;
index                           index.html index.php;

# Error pages
error_page                      500 502 503 504 /50x.html;
location = /50x.html            { root /usr/share/nginx/html; }

# Robots and favicon (no logging)
location = /robots.txt          { access_log off; log_not_found off; }
location = /favicon.ico         { access_log off; log_not_found off; }

# ACME Challenge (Let's Encrypt) - Must be accessible on HTTP
location ^~ /.well-known/acme-challenge/ {
    root                        /srv/${primary_vhost}/web/app/public;
}

# Autoconfig/Autodiscover (CRITICAL: Must come BEFORE generic .well-known)
# Works on both HTTP and HTTPS, redirects all vhosts to PRIMARY_VHOST
location ~* ^/(\.well-known/autoconfig/|mail/config-v1\.1\.xml|autodiscover/autodiscover\.xml) {
    fastcgi_pass                unix:/srv/${primary_vhost}/web/run/fpm.sock;
    include                     fastcgi_params;
    fastcgi_param               SCRIPT_FILENAME /srv/${primary_vhost}/web/app/public/.well-known/autoconfig.php;
    fastcgi_param               SCRIPT_NAME /autoconfig.php;
    fastcgi_param               SERVER_ADDR "";
    fastcgi_param               REMOTE_ADDR $http_x_real_ip;
}

# Allow other .well-known (except already handled above)
location ~ /\.well-known/       { allow all; }

# Deny all other dotfiles
location ~ /\.                  { deny all; access_log off; log_not_found off; }

# Static files with caching and security headers
location ~* \.(?:ico|css|js|jpg|jpeg|png|gif|woff|woff2|eot|ttf|svg|txt|pdf|zip|tgz|bz2|mp3|mp4|md)$ {
    access_log                  off;
    expires                     30d;
    add_header                  Pragma public;
    add_header                  Cache-Control "public, must-revalidate, proxy-revalidate";

    # Security headers (HTTPS only)
    if ($scheme = https) {
        add_header              Strict-Transport-Security "max-age=15768000; includeSubDomains; preload";
        add_header              X-Content-Type-Options nosniff;
        add_header              X-XSS-Protection "1; mode=block";
        add_header              X-Download-Options noopen;
        add_header              X-Permitted-Cross-Domain-Policies none;
    }
}

# Default location handler with HTTP â†’ HTTPS redirect
location / {
    # Redirect HTTP to HTTPS (except ACME/autoconfig already handled above)
    if ($server_port = 80) {
        return 301 https://$host$request_uri;
    }

    try_files $uri $uri/ /index.php$is_args$args;
}

# PHP-FPM processing
location ~ ^(.+\.php)(.*)$ {
    # Redirect HTTP to HTTPS for PHP files too
    if ($server_port = 80) {
        return 301 https://$host$request_uri;
    }

    try_files                   $uri =404;
    fastcgi_split_path_info     ^(.+\.php)(/.+)$;
    fastcgi_pass                unix:/srv/$host/web/run/fpm.sock;
    fastcgi_index               index.php;
    include                     fastcgi_params;
    fastcgi_read_timeout        300;
    fastcgi_param               PATH_INFO $fastcgi_path_info;
    fastcgi_param               PATH_TRANSLATED $document_root$fastcgi_path_info;
    fastcgi_param               SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param               SERVER_NAME $host;
    fastcgi_intercept_errors    on;

    # Security headers for PHP responses (HTTPS only)
    if ($scheme = https) {
        add_header              Strict-Transport-Security "max-age=15768000; includeSubDomains; preload";
        add_header              X-Content-Type-Options nosniff;
        add_header              X-XSS-Protection "1; mode=block";
        add_header              X-Download-Options noopen;
        add_header              X-Permitted-Cross-Domain-Policies none;
    }
}
